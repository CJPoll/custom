#!/bin/bash

set -euo pipefail

PROJECT_DIR="$(pwd)"
WORKTREES_DIR="$PROJECT_DIR/worktrees"

QUIET=false
MODIFY_GITIGNORE=false

usage() {
    cat << EOF
Usage: wt <command> [options]

Commands:
  init              Set up the worktrees directory
  list              List all worktrees for the current project
  create <branch>   Create a worktree for the specified branch
  rm <branch>       Remove the worktree for the specified branch
  switch <branch>   Change to the worktree for the specified branch

Options:
  --quiet           Suppress output from script and subcommands
  --gitignore       Modify .gitignore to exclude worktrees directory (for init command)

Examples:
  wt init
  wt init --gitignore
  wt list
  wt create feature/my-feature
  wt switch feature/my-feature
  wt rm feature/my-feature
  wt create --quiet bugfix/issue-123
EOF
}

log() {
    if [ "$QUIET" = false ]; then
        echo "$@" >&2
    fi
}

run_cmd() {
    if [ "$QUIET" = true ]; then
        "$@" >/dev/null 2>&1
    else
        "$@"
    fi
}

init_worktrees() {
    log "Initializing worktrees directory..."
    
    if [ ! -d "$PROJECT_DIR/.git" ]; then
        echo "Error: Not in a git repository" >&2
        exit 1
    fi
    
    mkdir -p "$WORKTREES_DIR"
    
    if [ "$MODIFY_GITIGNORE" = true ]; then
        if [ ! -f "$PROJECT_DIR/.gitignore" ]; then
            echo "worktrees/" > "$PROJECT_DIR/.gitignore"
            log "Created $PROJECT_DIR/.gitignore"
        else
            # Check if worktrees/ is already in .gitignore
            if ! grep -q "^worktrees/$" "$PROJECT_DIR/.gitignore"; then
                echo "worktrees/" >> "$PROJECT_DIR/.gitignore"
                log "Added worktrees/ to $PROJECT_DIR/.gitignore"
            fi
        fi
    fi
    
    log "Worktrees directory initialized at: $WORKTREES_DIR"
}

list_worktrees() {
    if [ ! -d "$WORKTREES_DIR" ]; then
        log "No worktrees directory found. Run 'wt init' first."
        return 0
    fi
    
    # Get list of directories in worktrees
    local worktrees=()
    if [ -d "$WORKTREES_DIR" ]; then
        while IFS= read -r -d '' dir; do
            worktrees+=("$(basename "$dir")")
        done < <(find "$WORKTREES_DIR" -mindepth 1 -maxdepth 1 -type d -print0 2>/dev/null)
    fi
    
    if [ ${#worktrees[@]} -eq 0 ]; then
        log "No worktrees found."
        return 0
    fi
    
    # Get current branch for comparison
    local current_branch
    current_branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
    
    log "Worktrees for this project:"
    log ""
    
    # Use git worktree list to get more info
    local git_worktrees
    git_worktrees=$(git worktree list 2>/dev/null || echo "")
    
    for worktree in "${worktrees[@]}"; do
        local marker=""
        local worktree_path="$WORKTREES_DIR/$worktree"
        
        # Check if this is the current directory
        if [[ "$(pwd)" == "$worktree_path" ]]; then
            marker=" *"
        fi
        
        # Try to get the commit info from git worktree list
        local commit_info=""
        if [[ -n "$git_worktrees" ]]; then
            commit_info=$(echo "$git_worktrees" | grep "$worktree_path" | awk '{print $2, $3}' || echo "")
        fi
        
        if [[ -n "$commit_info" ]]; then
            echo "  $worktree$marker ($commit_info)"
        else
            echo "  $worktree$marker"
        fi
    done
}

create_worktree() {
    local branch="$1"
    local worktree_path="$WORKTREES_DIR/$branch"
    
    if [ -z "$branch" ]; then
        echo "Error: Branch name is required" >&2
        usage
        exit 1
    fi
    
    if [ ! -d "$WORKTREES_DIR" ]; then
        log "Worktrees directory not found. Running init first..."
        init_worktrees
    fi
    
    if [ -d "$worktree_path" ]; then
        echo "Error: Worktree already exists at: $worktree_path" >&2
        exit 1
    fi
    
    log "Creating worktree for branch: $branch"
    
    # Check if branch exists
    if git show-ref --verify --quiet "refs/heads/$branch"; then
        log "Checking out existing branch: $branch"
        run_cmd git worktree add "$worktree_path" "$branch"
    else
        # Check if it exists as a remote branch
        if git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
            log "Creating local branch from remote: origin/$branch"
            run_cmd git worktree add "$worktree_path" -b "$branch" "origin/$branch"
        else
            log "Creating new branch: $branch"
            run_cmd git worktree add "$worktree_path" -b "$branch"
        fi
    fi
    
    log "Worktree created at: $worktree_path"
}

remove_worktree() {
    local branch="$1"
    local worktree_path="$WORKTREES_DIR/$branch"
    
    if [ -z "$branch" ]; then
        echo "Error: Branch name is required" >&2
        usage
        exit 1
    fi
    
    if [ ! -d "$worktree_path" ]; then
        echo "Error: Worktree not found at: $worktree_path" >&2
        exit 1
    fi
    
    log "Removing worktree for branch: $branch"
    
    # Remove the worktree
    run_cmd git worktree remove "$worktree_path" --force
    
    # Clean up any remaining directory if it exists
    if [ -d "$worktree_path" ]; then
        rm -rf "$worktree_path"
    fi
    
    # Prune worktree metadata
    run_cmd git worktree prune
    
    log "Worktree removed: $branch"
}

switch_worktree() {
    local branch="$1"
    local worktree_path="$WORKTREES_DIR/$branch"
    
    if [ -z "$branch" ]; then
        echo "Error: Branch name is required" >&2
        usage
        return 1
    fi
    
    if [ ! -d "$worktree_path" ]; then
        echo "Error: Worktree not found at: $worktree_path" >&2
        echo "Available worktrees:" >&2
        if [ -d "$WORKTREES_DIR" ]; then
            ls -1 "$WORKTREES_DIR" 2>/dev/null | sed 's/^/  /' >&2
        fi
        return 1
    fi
    
    log "Switching to worktree: $branch"
    
    # Output the cd command for the shell to evaluate
    echo "cd \"$worktree_path\""
}

# Parse command line arguments
COMMAND=""
BRANCH=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --quiet)
            QUIET=true
            shift
            ;;
        --gitignore)
            MODIFY_GITIGNORE=true
            shift
            ;;
        init|list|create|rm|switch)
            COMMAND="$1"
            shift
            if [[ "$COMMAND" == "create" || "$COMMAND" == "rm" || "$COMMAND" == "switch" ]] && [[ $# -gt 0 ]] && [[ ! "$1" =~ ^-- ]]; then
                BRANCH="$1"
                shift
            fi
            ;;
        -h|--help|help)
            usage
            exit 0
            ;;
        *)
            echo "Error: Unknown argument: $1" >&2
            usage
            exit 1
            ;;
    esac
done

# Execute the appropriate command
case "$COMMAND" in
    init)
        init_worktrees
        ;;
    list)
        list_worktrees
        ;;
    create)
        create_worktree "$BRANCH"
        ;;
    rm)
        remove_worktree "$BRANCH"
        ;;
    switch)
        switch_worktree "$BRANCH"
        ;;
    "")
        echo "Error: No command specified" >&2
        usage
        exit 1
        ;;
    *)
        echo "Error: Unknown command: $COMMAND" >&2
        usage
        exit 1
        ;;
esac

